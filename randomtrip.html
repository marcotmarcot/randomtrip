<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Wild Journey</title>
    <style>
     html, body, #map-canvas {
       height: 100%;
       margin: 0px;
       padding: 0px
     }
    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    <script src="src/Range.js"></script>
    <script type="text/javascript">
     function toLat(n) {
       return Math.acos(2 * n - 1) / Math.PI * 180 - 90;
     }

     function toLong(n) {
       return n * 360 - 180;
     }

     function pickedsFromURL() {
       qs = location.href.split('?')[1];
       if (!qs) {
         return [];
       }
       params = qs.split('&');
       for (i in params) {
         param = params[i].split('=');
         if (param[0] === "pickeds") {
           if (params[1]) {
             return param[1].split('.');
           }
         }
       }
       return [];
     }

     function RandomPlace(base) {
       this.base = base;
       this.latLong = [new Range(base), new Range(base)];
       this.isLong = false;
     }

     RandomPlace.prototype.addPicked = function(picked) {
       this.latLong[+this.isLong].addPicked(picked);
       this.isLong = !this.isLong;
     }

     RandomPlace.prototype.longMiddle = function() {
       return (this.longEnd + this.longStart) / 2;
     }

     RandomPlace.prototype.getLatStart = function() {
       return toLat(this.latLong[0].start);
     }

     RandomPlace.prototype.getLatEnd = function() {
       return toLat(this.latLong[0].end);
     }

     RandomPlace.prototype.getLongStart = function() {
       return toLong(this.latLong[1].start);
     }

     RandomPlace.prototype.getLongEnd = function() {
       return toLong(this.latLong[1].end);
     }

     RandomPlace.prototype.getLatCenter = function() {
       return toLat(this.latLong[0].center());
     }

     RandomPlace.prototype.getLongCenter = function() {
       return toLong(this.latLong[1].center());
     }

     RandomPlace.prototype.getCenter = function() {
       return new google.maps.LatLng(this.getLatCenter(), this.getLongCenter())
     }

     RandomPlace.prototype.getBounds = function() {
       return new google.maps.LatLngBounds(
         new google.maps.LatLng(this.getLatStart(), this.getLongStart()),
         new google.maps.LatLng(this.getLatEnd(), this.getLongEnd()))
     }

     function Link(path) {
       this.link = $(path);
     }

     Link.prototype.setLink = function(link) {
       this.link.text(link);
       this.link.attr('href', link);
     }

     function Html(rt) {
       this.diceValue = $("#dice-value");
       this.info = $("#info");
       this.originalLink = location.href.split('?')[0];
       this.dice = $("#dice")
       this.reset = $("#reset")
       this.link = new Link("#link");
       this.rt = rt;

       this.dice.submit(function(event) {
         event.preventDefault();
         this.rt.addPicked(this.diceValue.val());
       });

       this.reset.click(function() {
         this.rt.reset();
         return false;
       });
     }

     Html.prototype.reset = function() {
       this.diceValue.val("");
       this.info.text(this.rt.rp.getCenter());
       this.link.setLink(this.originalLink);
     }

     Html.prototype.addPicked = function(picked) {
       var link = this.link.link;
       if (this.rt.pickeds.length === 1) {
         link += "?";
       }
       else {
         link += ".";
       }
       link += picked;
     }

     Html.prototype.setLink = function() {
       var link = this.originalLink;
       if (rt.pickeds.length !== 0) {
         link += "?" + $.param({"pickeds" : rt.pickeds.join(".")});
       }
       this.link.setLink(link);
     }

     function Map(base) {
       this.initialMapZoom = 0;
       this.map = new google.maps.Map(document.getElementById('map-canvas'), {
         mapTypeId: google.maps.MapTypeId.TERRAIN
       });

       this.rectangle = new google.maps.Rectangle({
         strokeColor: '#FF0000',
         strokeOpacity: 0.8,
         strokeWeight: 2,
         fillColor: '#FF0000',
         fillOpacity: 0.35,
         map: this.map,
       });

       this.marker = new google.maps.Marker({
         map: this.map
       });
     }

     Map.prototype.addPicked = function(rp) {
       this.map.setZoom(this.map.getZoom() + 1);
       this.update(rp);
     }

     Map.prototype.reset = function(rp) {
       this.map.setZoom(this.initialMapZoom);
       this.update(rp);
     }

     Map.prototype.update = function(rp) {
       this.map.setCenter(rp.getCenter());
       this.rectangle.setBounds(rp.getBounds());
       this.marker.setPosition(rp.getCenter());
     }

     function RandomTrip(base) {
       this.rp = new RandomPlace(this.base);
       this.html = new Html(this);
       this.map = new Map(this.rp);

       this.reset();
     }

     RandomTrip.prototype.addPicked = function(picked) {
       this.rp.addPicked(picked);
       this.pickeds.push(picked);
       this.html.addPicked(picked);
       this.map.addPicked();
     }

     RandomTrip.prototype.reset = function() {
       this.rp.reset();
       this.pickeds = [];
       this.html.reset();
       this.map.reset();
     }

     function initialize() {
       var rt = new RandomTrip(6);
     }

     $(function () {
       setLink(location.href);
       google.maps.event.addDomListener(window, 'load', initialize);
     });
    </script>
  </head>
  <body>
    <form id="dice" action=".">
      <input id="dice-value" type="text" name="value">
      <input type="submit" value="go">
    </form>
    <a id="reset" href="#">reset</a>
    <div id="info">(0, 0)</div>
    <a id="link" href="#">link</a>
    <div id="map-canvas"></div>
  </body>
</html>
